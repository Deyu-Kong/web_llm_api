# Context.md

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

**é¡¹ç›®åç§°**: WebLLM / Pantheon API  
**ç‰ˆæœ¬**: v0.3.0  
**æ ¸å¿ƒåŠŸèƒ½**: é€šè¿‡æµè§ˆå™¨è‡ªåŠ¨åŒ–æŠ€æœ¯ï¼ˆDrissionPageï¼‰å°†ç½‘é¡µç‰ˆ LLM å°è£…ä¸ºæœ¬åœ° RESTful APIï¼Œå¹¶æ”¯æŒ **OpenAI å…¼å®¹åè®®**ã€‚

### æŠ€æœ¯æ ˆ
- **Web è‡ªåŠ¨åŒ–**: DrissionPage (Chrome DevTools Protocol)
- **API æ¡†æ¶**: FastAPI + Uvicorn
- **æ•°æ®éªŒè¯**: Pydantic
- **è¯­è¨€ç‰ˆæœ¬**: Python 3.12+
- **å…¼å®¹åè®®**: OpenAI API Standard

---

## ğŸ—ï¸ é¡¹ç›®æ¶æ„

```
WebLLM/
â”œâ”€â”€ adapters/           # é€‚é…å™¨å±‚ - å„ LLM å¹³å°çš„å…·ä½“å®ç°
â”‚   â”œâ”€â”€ base_bot.py     # æŠ½è±¡åŸºç±»
â”‚   â”œâ”€â”€ kimi_bot.py     # Kimi é€‚é…å™¨
â”‚   â”œâ”€â”€ lmarena_bot.py  # LMArena é€‚é…å™¨ (æ”¯æŒå¤šæ¨¡å‹)
â”‚   â””â”€â”€ __init__.py
â”œâ”€â”€ core/               # æ ¸å¿ƒå±‚ - å…¬å…±é€»è¾‘ï¼ˆé¢„ç•™æ‰©å±•ï¼‰
â”œâ”€â”€ tests/              # æµ‹è¯•æ¨¡å—
â”‚   â”œâ”€â”€ test_kimi.py    # Kimi æ¥å£æµ‹è¯•
â”‚   â”œâ”€â”€ test_lmarena.py # LMArena æ¥å£æµ‹è¯•
â”‚   â””â”€â”€ test_openai.py  # OpenAI SDK å…¼å®¹æ€§æµ‹è¯•
â”œâ”€â”€ config.py           # é…ç½®ç®¡ç†
â”œâ”€â”€ main.py             # API æœåŠ¡å…¥å£
â””â”€â”€ requirements.txt    # ä¾èµ–å£°æ˜
```

---

## ğŸ“ æ–‡ä»¶åŠŸèƒ½èŒè´£

### 1ï¸âƒ£ **æ ¹ç›®å½•æ–‡ä»¶**

#### `main.py` - API æœåŠ¡ä¸»ç¨‹åº
**èŒè´£**:
- FastAPI åº”ç”¨åˆå§‹åŒ–å’Œé…ç½®
- æµè§ˆå™¨è¿æ¥ç®¡ç†ï¼ˆå¯åŠ¨æ—¶è¿æ¥ Chrome è°ƒè¯•ç«¯å£ï¼‰
- Bot å®ä¾‹åŒ–å’Œç”Ÿå‘½å‘¨æœŸç®¡ç† (KimiBot, LMArenaBot)
- **è·¯ç”±åˆ†å‘**: æ ¹æ®æ¨¡å‹åç§°å°†è¯·æ±‚è·¯ç”±åˆ°å¯¹åº”çš„ Bot
- **API å®šä¹‰**: æä¾›åŸç”Ÿæ¥å£å’Œ OpenAI å…¼å®¹æ¥å£

**å…³é”®è·¯ç”±**:
- `GET /v1/models` - è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨ (OpenAI æ ¼å¼)
- `POST /v1/chat/completions` - **OpenAI å…¼å®¹å¯¹è¯æ¥å£**
- `POST /v1/chat/kimi` - Kimi åŸç”Ÿæ¥å£
- `POST /v1/chat/lmarena` - LMArena åŸç”Ÿæ¥å£

**å¯åŠ¨æµç¨‹**:
1. è¯»å–é…ç½®
2. è¿æ¥ Chrome è°ƒè¯•ç«¯å£ (9222)
3. åˆå§‹åŒ–æ‰€æœ‰ Bot å®ä¾‹
4. å¯åŠ¨ uvicorn æœåŠ¡

---

#### `config.py` - å…¨å±€é…ç½®æ–‡ä»¶
**èŒè´£**: é›†ä¸­ç®¡ç†æ‰€æœ‰é…ç½®é¡¹

**æ–°å¢é…ç½®**:
- `LMARENA_URL`: LMArena ç›´è¿æ¨¡å¼ç½‘å€
- `DEFAULT_LMARENA_MODEL`: LMArena çš„é»˜è®¤æ¨¡å‹åç§°

---

#### `requirements.txt` - Python ä¾èµ–
**æ ¸å¿ƒä¾èµ–**:
- `DrissionPage>=4.0.0` - æµè§ˆå™¨è‡ªåŠ¨åŒ–åº“
- `fastapi>=0.110.0` - Web æ¡†æ¶
- `uvicorn>=0.27.0` - ASGI æœåŠ¡å™¨
- `pydantic>=2.7.0` - æ•°æ®éªŒè¯
- `openai>=1.0.0` - ç”¨äºæµ‹è¯• SDK å…¼å®¹æ€§

---

### 2ï¸âƒ£ **adapters/ - é€‚é…å™¨æ¨¡å—**

#### `base_bot.py` - æŠ½è±¡åŸºç±»
**èŒè´£**: å®šä¹‰æ‰€æœ‰ Bot å¿…é¡»å®ç°çš„æ¥å£è§„èŒƒ

**æ ¸å¿ƒæ¥å£**:
```python
activate() -> bool           # æ¿€æ´»/è·³è½¬åˆ°å¯¹åº”æ ‡ç­¾é¡µ
ask(query: str) -> str      # å‘é€é—®é¢˜å¹¶è·å–å›ç­”
new_chat() -> bool          # å¼€å¯æ–°å¯¹è¯ï¼ˆæ¸…é™¤ä¸Šä¸‹æ–‡ï¼‰
```

**è®¾è®¡æ¨¡å¼**: æŠ½è±¡åŸºç±»ï¼ˆABCï¼‰ï¼Œå¼ºåˆ¶å­ç±»å®ç°æ ¸å¿ƒæ–¹æ³•

---

#### `kimi_bot.py` - Kimi å¹³å°é€‚é…å™¨
å®ç° Kimi ç½‘é¡µç‰ˆçš„äº¤äº’é€»è¾‘ï¼ŒåŒ…å«è¾“å…¥æ¡†å®šä½å’Œå›å¤ç­‰å¾…ã€‚

#### `lmarena_bot.py` - LMArena é€‚é…å™¨ (âœ¨æ–°å¢)
**èŒè´£**: å®ç° lmarena.ai çš„äº¤äº’ï¼Œæ”¯æŒåŠ¨æ€åˆ‡æ¢æ¨¡å‹ã€‚
**æ ¸å¿ƒåŠŸèƒ½**:
- **æ¨¡å‹é€‰æ‹© (`_select_model`)**: 
  - ä½¿ç”¨å¤šç§ç­–ç•¥ (XPath, CSS, æ–‡æœ¬åŒ¹é…) ç²¾ç¡®å®šä½ Combobox æŒ‰é’®ã€‚
  - æ”¯æŒ JS ç‚¹å‡»å’Œæ¨¡æ‹Ÿæ“ä½œï¼Œè§£å†³å…ƒç´ é®æŒ¡é—®é¢˜ã€‚
- **å›å¤è§£æ (`_get_last_answer`)**: 
  - åŒæ—¶æå– **æ€è€ƒè¿‡ç¨‹ (Thought)** å’Œ **æœ€ç»ˆå›ç­” (Answer)**ã€‚
  - è¿”å›ç»“æ„åŒ–å­—å…¸ `{"thought": "...", "answer": "..."}`ã€‚
- **å¤šæ¨¡å‹æ”¯æŒ**: å…è®¸åœ¨è¿è¡Œæ—¶é€šè¿‡ä¸‹æ‹‰èœå•åˆ‡æ¢æ¨¡å‹ã€‚

---

#### `claude_bot.py` / `gpt_bot.py` - å¾…å®ç°
**çŠ¶æ€**: ç©ºæ–‡ä»¶ï¼ˆå ä½ï¼‰  
**è®¡åˆ’**: å‚è€ƒ `kimi_bot.py` å®ç° Claude å’Œ ChatGPT çš„é€‚é…å™¨

---

#### `__init__.py` - æ¨¡å—å¯¼å‡º
**èŒè´£**: ç»Ÿä¸€å¯¼å‡ºæ¥å£ï¼Œç®€åŒ–å¯¼å…¥è·¯å¾„

```python
from .base_bot import BaseBot
from .kimi_bot import KimiBot
__all__ = ["BaseBot", "KimiBot"]
```

---

### 3ï¸âƒ£ **core/ - æ ¸å¿ƒæ¨¡å—ï¼ˆé¢„ç•™ï¼‰**

**å½“å‰çŠ¶æ€**: æ‰€æœ‰æ–‡ä»¶ä¸ºç©ºï¼Œä»…ä½œä¸ºå ä½ç¬¦  
**æœªæ¥è§„åˆ’**:
- `browser.py` - æµè§ˆå™¨è¿æ¥æ± ç®¡ç†ã€å¤šæ ‡ç­¾é¡µåè°ƒ
- `manager.py` - Bot ç®¡ç†å™¨ã€è´Ÿè½½å‡è¡¡ã€ä»»åŠ¡é˜Ÿåˆ—
- `utils.py` - å…¬å…±å·¥å…·å‡½æ•°ï¼ˆæ—¥å¿—ã€é‡è¯•æœºåˆ¶ç­‰ï¼‰

---

## ğŸ”„ æ ¸å¿ƒå·¥ä½œæµç¨‹

### 1. æœåŠ¡å¯åŠ¨æµç¨‹
```
å¯åŠ¨ main.py
  â†“
è¯»å– config.py é…ç½®
  â†“
è¿æ¥ Chrome è°ƒè¯•ç«¯å£ï¼ˆ9222ï¼‰
  â†“
åˆå§‹åŒ– KimiBot å®ä¾‹
  â†“
å¯åŠ¨ FastAPI æœåŠ¡ï¼ˆ8000 ç«¯å£ï¼‰
```

### 2. API è°ƒç”¨æµç¨‹ï¼ˆä»¥ OpenAI API ä¸ºä¾‹ï¼‰
```
å®¢æˆ·ç«¯ (OpenAI SDK)
  â†“
POST /v1/chat/completions
  â†“
main.py: parse_model_name() è§£ææ¨¡å‹å‰ç¼€
  â†“
main.py: route_to_bot() åˆ†å‘è¯·æ±‚
  â”œâ”€ case "kimi": è°ƒç”¨ KimiBot.ask()
  â””â”€ case "lmarena": è°ƒç”¨ LMArenaBot.ask(model_name="...")
       â†“
     LMArenaBot: æ£€æŸ¥å½“å‰æ¨¡å‹ -> ä¸‹æ‹‰åˆ‡æ¢æ¨¡å‹ (å¦‚æœéœ€è¦) -> æé—® -> è·å–(æ€è€ƒ+å›ç­”)
       â†“
     å°è£…ä¸º OpenAI ChatCompletionChunk æ ¼å¼
  â†“
è¿”å› JSON å“åº”
```

---

## ğŸ¯ æ‰©å±•æŒ‡å—

### æ·»åŠ æ–°çš„ LLM å¹³å°é€‚é…å™¨

1. **åˆ›å»ºæ–‡ä»¶**: `adapters/xxx_bot.py`
2. **ç»§æ‰¿åŸºç±»**: 
   ```python
   from .base_bot import BaseBot
   
   class XxxBot(BaseBot):
       def __init__(self, page):
           super().__init__(page)
           self.name = "Xxx"
           self.url = "https://..."
   ```
3. **å®ç°æ–¹æ³•**: `activate()`, `ask()`, `new_chat()`
4. **æ³¨å†Œè·¯ç”±**: åœ¨ `main.py` æ·»åŠ å¯¹åº” API è·¯ç”±
5. **æ›´æ–°å¯¼å‡º**: åœ¨ `adapters/__init__.py` æ·»åŠ å¯¼å‡º


## âš ï¸ æ³¨æ„äº‹é¡¹

### å‰ç½®è¦æ±‚
1. **æ‰‹åŠ¨ç™»å½•**: å¯åŠ¨æœåŠ¡å‰éœ€åœ¨æµè§ˆå™¨ä¸­ç™»å½•å¯¹åº”å¹³å°
2. **é…ç½®ä¿®æ”¹**: é¦–æ¬¡ä½¿ç”¨ä¿®æ”¹ `config.py` ä¸­çš„è·¯å¾„é…ç½®

### å¸¸è§é—®é¢˜
- **è¿æ¥å¤±è´¥**: æ£€æŸ¥ Chrome æ˜¯å¦ä»¥è°ƒè¯•æ¨¡å¼å¯åŠ¨
- **å›å¤è¶…æ—¶**: è°ƒæ•´ `MAX_WAIT_TIME` æˆ–æ£€æŸ¥ç½‘ç»œ

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- **DrissionPage æ–‡æ¡£**: https://drissionpage.cn/
- **FastAPI æ–‡æ¡£**: https://fastapi.tiangolo.com/
- **API è°ƒè¯•ç•Œé¢**: http://127.0.0.1:8000/docs (Swagger UI)

---

**æœ€åæ›´æ–°**: 2025-12-23
**ç»´æŠ¤è€…**: kdy 
**è®¸å¯**: æœªæŒ‡å®š