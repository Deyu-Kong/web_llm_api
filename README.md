# Context.md

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

**é¡¹ç›®åç§°**: WebLLM / Pantheon API  
**ç‰ˆæœ¬**: v0.1.0  
**æ ¸å¿ƒåŠŸèƒ½**: é€šè¿‡æµè§ˆå™¨è‡ªåŠ¨åŒ–æŠ€æœ¯ï¼ˆDrissionPageï¼‰å°†ç½‘é¡µç‰ˆ LLM å°è£…ä¸ºæœ¬åœ° RESTful API

### æŠ€æœ¯æ ˆ
- **Web è‡ªåŠ¨åŒ–**: DrissionPage (Chrome DevTools Protocol)
- **API æ¡†æ¶**: FastAPI + Uvicorn
- **æ•°æ®éªŒè¯**: Pydantic
- **è¯­è¨€ç‰ˆæœ¬**: Python 3.12+

---

## ğŸ—ï¸ é¡¹ç›®æ¶æ„

```
WebLLM/
â”œâ”€â”€ adapters/           # é€‚é…å™¨å±‚ - å„ LLM å¹³å°çš„å…·ä½“å®ç°
â”œâ”€â”€ core/              # æ ¸å¿ƒå±‚ - å…¬å…±é€»è¾‘ï¼ˆé¢„ç•™æ‰©å±•ï¼‰
â”œâ”€â”€ config.py          # é…ç½®ç®¡ç†
â”œâ”€â”€ main.py            # API æœåŠ¡å…¥å£
â”œâ”€â”€ test.py            # æµ‹è¯•è„šæœ¬
â””â”€â”€ requirements.txt   # ä¾èµ–å£°æ˜
```

---

## ğŸ“ æ–‡ä»¶åŠŸèƒ½èŒè´£

### 1ï¸âƒ£ **æ ¹ç›®å½•æ–‡ä»¶**

#### `main.py` - API æœåŠ¡ä¸»ç¨‹åº
**èŒè´£**:
- FastAPI åº”ç”¨åˆå§‹åŒ–å’Œé…ç½®
- æµè§ˆå™¨è¿æ¥ç®¡ç†ï¼ˆå¯åŠ¨æ—¶è¿æ¥ Chrome è°ƒè¯•ç«¯å£ï¼‰
- Bot å®ä¾‹åŒ–å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†
- RESTful API è·¯ç”±å®šä¹‰

**å…³é”®è·¯ç”±**:
- `GET /` - æœåŠ¡çŠ¶æ€å’Œå¯ç”¨æ¨¡å‹åˆ—è¡¨
- `GET /health` - å¥åº·æ£€æŸ¥
- `POST /v1/chat/kimi` - Kimi å¯¹è¯æ¥å£

**å¯åŠ¨æµç¨‹**:
1. è¯»å–é…ç½®ï¼ˆChrome ç«¯å£ã€ç”¨æˆ·æ•°æ®ç›®å½•ï¼‰
2. è¿æ¥åˆ°å·²å¯åŠ¨çš„ Chrome è°ƒè¯•ç«¯å£ï¼ˆ9222ï¼‰
3. åˆå§‹åŒ– KimiBot å®ä¾‹
4. å¯åŠ¨ FastAPI æœåŠ¡ï¼ˆé»˜è®¤ç«¯å£ 8000ï¼‰

---

#### `config.py` - å…¨å±€é…ç½®æ–‡ä»¶
**èŒè´£**: é›†ä¸­ç®¡ç†æ‰€æœ‰é…ç½®é¡¹

**é…ç½®é¡¹**:
- `CHROME_PORT`: Chrome è¿œç¨‹è°ƒè¯•ç«¯å£ï¼ˆé»˜è®¤ 9222ï¼‰
- `CHROME_USER_DATA_DIR`: Chrome ç”¨æˆ·æ•°æ®ç›®å½•è·¯å¾„
- `KIMI_URL`: Kimi å¹³å°ç½‘å€
- `STABLE_WAIT_TIME`: AI å›å¤ç¨³å®šæ£€æµ‹æ—¶é—´ï¼ˆ2sï¼‰
- `CHECK_INTERVAL`: å›å¤æ£€æµ‹é—´éš”ï¼ˆ0.5sï¼‰
- `MAX_WAIT_TIME`: æœ€å¤§ç­‰å¾…è¶…æ—¶ï¼ˆ120sï¼‰

**ä¿®æ”¹å»ºè®®**:
- é¦–æ¬¡ä½¿ç”¨éœ€ä¿®æ”¹ `CHROME_USER_DATA_DIR` ä¸ºå®é™…è·¯å¾„
- æ ¹æ®ç½‘ç»œæƒ…å†µè°ƒæ•´è¶…æ—¶å‚æ•°

---

#### `test.py` - é›†æˆæµ‹è¯•è„šæœ¬
**èŒè´£**: éªŒè¯ API æœåŠ¡æ˜¯å¦æ­£å¸¸å·¥ä½œ

**æµ‹è¯•ç”¨ä¾‹**:
1. `test_health()` - å¥åº·æ£€æŸ¥æ¥å£æµ‹è¯•
2. `test_kimi_chat()` - Kimi å¯¹è¯åŠŸèƒ½æµ‹è¯•

**ä½¿ç”¨æ–¹æ³•**:
```bash
# ç¡®ä¿ main.py å·²å¯åŠ¨åæ‰§è¡Œ
python test.py
```

---

#### `requirements.txt` - Python ä¾èµ–
**æ ¸å¿ƒä¾èµ–**:
- `DrissionPage>=4.0.0` - æµè§ˆå™¨è‡ªåŠ¨åŒ–åº“
- `fastapi>=0.110.0` - Web æ¡†æ¶
- `uvicorn>=0.27.0` - ASGI æœåŠ¡å™¨
- `pydantic>=2.7.0` - æ•°æ®éªŒè¯

---

### 2ï¸âƒ£ **adapters/ - é€‚é…å™¨æ¨¡å—**

#### `base_bot.py` - æŠ½è±¡åŸºç±»
**èŒè´£**: å®šä¹‰æ‰€æœ‰ Bot å¿…é¡»å®ç°çš„æ¥å£è§„èŒƒ

**æ ¸å¿ƒæ¥å£**:
```python
activate() -> bool           # æ¿€æ´»/è·³è½¬åˆ°å¯¹åº”æ ‡ç­¾é¡µ
ask(query: str) -> str      # å‘é€é—®é¢˜å¹¶è·å–å›ç­”
new_chat() -> bool          # å¼€å¯æ–°å¯¹è¯ï¼ˆæ¸…é™¤ä¸Šä¸‹æ–‡ï¼‰
```

**è®¾è®¡æ¨¡å¼**: æŠ½è±¡åŸºç±»ï¼ˆABCï¼‰ï¼Œå¼ºåˆ¶å­ç±»å®ç°æ ¸å¿ƒæ–¹æ³•

---

#### `kimi_bot.py` - Kimi å¹³å°é€‚é…å™¨
**èŒè´£**: å®ç° Kimi (moonshot.cn) çš„å…·ä½“äº¤äº’é€»è¾‘

**æ ¸å¿ƒæ–¹æ³•**:
- `activate()` - æŸ¥æ‰¾æˆ–æ‰“å¼€ Kimi æ ‡ç­¾é¡µ
- `ask(query)` - å®Œæ•´å¯¹è¯æµç¨‹
  1. å®šä½è¾“å…¥æ¡†ï¼ˆ`_find_input_box`ï¼‰
  2. è¾“å…¥é—®é¢˜ + å›è½¦å‘é€
  3. ç­‰å¾…å›å¤å®Œæˆï¼ˆ`_wait_for_response`ï¼‰
  4. æå–å›ç­”æ–‡æœ¬ï¼ˆ`_get_last_answer`ï¼‰
- `new_chat()` - ç‚¹å‡»"æ–°å¯¹è¯"æŒ‰é’®æˆ–åˆ·æ–°é¡µé¢

**æŠ€æœ¯ç»†èŠ‚**:
- ä½¿ç”¨å¤šç§ CSS é€‰æ‹©å™¨ç­–ç•¥æé«˜é²æ£’æ€§
- åŸºäºæ–‡æœ¬ç¨³å®šæ€§æ£€æµ‹å›å¤æ˜¯å¦å®Œæˆ
- è¯¦ç»†çš„æ—¥å¿—è¾“å‡ºä¾¿äºè°ƒè¯•

---

#### `claude_bot.py` / `gpt_bot.py` - å¾…å®ç°
**çŠ¶æ€**: ç©ºæ–‡ä»¶ï¼ˆå ä½ï¼‰  
**è®¡åˆ’**: å‚è€ƒ `kimi_bot.py` å®ç° Claude å’Œ ChatGPT çš„é€‚é…å™¨

---

#### `__init__.py` - æ¨¡å—å¯¼å‡º
**èŒè´£**: ç»Ÿä¸€å¯¼å‡ºæ¥å£ï¼Œç®€åŒ–å¯¼å…¥è·¯å¾„

```python
from .base_bot import BaseBot
from .kimi_bot import KimiBot
__all__ = ["BaseBot", "KimiBot"]
```

---

### 3ï¸âƒ£ **core/ - æ ¸å¿ƒæ¨¡å—ï¼ˆé¢„ç•™ï¼‰**

**å½“å‰çŠ¶æ€**: æ‰€æœ‰æ–‡ä»¶ä¸ºç©ºï¼Œä»…ä½œä¸ºå ä½ç¬¦  
**æœªæ¥è§„åˆ’**:
- `browser.py` - æµè§ˆå™¨è¿æ¥æ± ç®¡ç†ã€å¤šæ ‡ç­¾é¡µåè°ƒ
- `manager.py` - Bot ç®¡ç†å™¨ã€è´Ÿè½½å‡è¡¡ã€ä»»åŠ¡é˜Ÿåˆ—
- `utils.py` - å…¬å…±å·¥å…·å‡½æ•°ï¼ˆæ—¥å¿—ã€é‡è¯•æœºåˆ¶ç­‰ï¼‰

---

## ğŸ”„ æ ¸å¿ƒå·¥ä½œæµç¨‹

### 1. æœåŠ¡å¯åŠ¨æµç¨‹
```
å¯åŠ¨ main.py
  â†“
è¯»å– config.py é…ç½®
  â†“
è¿æ¥ Chrome è°ƒè¯•ç«¯å£ï¼ˆ9222ï¼‰
  â†“
åˆå§‹åŒ– KimiBot å®ä¾‹
  â†“
å¯åŠ¨ FastAPI æœåŠ¡ï¼ˆ8000 ç«¯å£ï¼‰
```

### 2. API è°ƒç”¨æµç¨‹ï¼ˆä»¥ Kimi ä¸ºä¾‹ï¼‰
```
å®¢æˆ·ç«¯ POST /v1/chat/kimi
  â†“
FastAPI æ¥æ”¶è¯·æ±‚ï¼ˆChatRequestï¼‰
  â†“
KimiBot.activate() - æ¿€æ´»æ ‡ç­¾é¡µ
  â†“
KimiBot.ask(query)
  â”œâ”€ _find_input_box() - å®šä½è¾“å…¥æ¡†
  â”œâ”€ è¾“å…¥é—®é¢˜ + å›è½¦
  â”œâ”€ _wait_for_response() - ç­‰å¾…å›å¤
  â”‚   â””â”€ _get_last_answer() - è½®è¯¢æ£€æµ‹
  â””â”€ è¿”å›å›ç­”æ–‡æœ¬
  â†“
å°è£…ä¸º ChatResponse è¿”å›
```

---

## ğŸ¯ æ‰©å±•æŒ‡å—

### æ·»åŠ æ–°çš„ LLM å¹³å°é€‚é…å™¨

1. **åˆ›å»ºæ–‡ä»¶**: `adapters/xxx_bot.py`
2. **ç»§æ‰¿åŸºç±»**: 
   ```python
   from .base_bot import BaseBot
   
   class XxxBot(BaseBot):
       def __init__(self, page):
           super().__init__(page)
           self.name = "Xxx"
           self.url = "https://..."
   ```
3. **å®ç°æ–¹æ³•**: `activate()`, `ask()`, `new_chat()`
4. **æ³¨å†Œè·¯ç”±**: åœ¨ `main.py` æ·»åŠ å¯¹åº” API è·¯ç”±
5. **æ›´æ–°å¯¼å‡º**: åœ¨ `adapters/__init__.py` æ·»åŠ å¯¼å‡º

### å‚è€ƒ KimiBot çš„å®ç°è¦ç‚¹ï¼š
- ä½¿ç”¨å¤šç§é€‰æ‹©å™¨ç­–ç•¥æé«˜å…¼å®¹æ€§
- åŸºäºæ–‡æœ¬ç¨³å®šæ€§åˆ¤æ–­å›å¤å®Œæˆ
- å®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è¾“å‡º
- æ”¯æŒ `new_chat` å‚æ•°æ§åˆ¶å¯¹è¯ä¸Šä¸‹æ–‡

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### å‰ç½®è¦æ±‚
1. **Chrome è°ƒè¯•æ¨¡å¼å¯åŠ¨**:
   ```bash
   chrome.exe --remote-debugging-port=9222 --user-data-dir="D:\chrome_WebLLM_profile"
   ```
2. **æ‰‹åŠ¨ç™»å½•**: å¯åŠ¨æœåŠ¡å‰éœ€åœ¨æµè§ˆå™¨ä¸­ç™»å½•å¯¹åº”å¹³å°
3. **é…ç½®ä¿®æ”¹**: é¦–æ¬¡ä½¿ç”¨ä¿®æ”¹ `config.py` ä¸­çš„è·¯å¾„é…ç½®

### å¸¸è§é—®é¢˜
- **è¿æ¥å¤±è´¥**: æ£€æŸ¥ Chrome æ˜¯å¦ä»¥è°ƒè¯•æ¨¡å¼å¯åŠ¨
- **æ‰¾ä¸åˆ°è¾“å…¥æ¡†**: ç¡®è®¤å·²ç™»å½•ä¸”åœ¨å¯¹è¯é¡µé¢
- **å›å¤è¶…æ—¶**: è°ƒæ•´ `MAX_WAIT_TIME` æˆ–æ£€æŸ¥ç½‘ç»œ

---

## ğŸ“ å¼€å‘å»ºè®®

### ç»™ LLM çš„æç¤º
1. **ä¿®æ”¹ç°æœ‰ Bot**: é‡ç‚¹å…³æ³¨é€‰æ‹©å™¨å®šä½é€»è¾‘å’Œç­‰å¾…æœºåˆ¶
2. **æ·»åŠ æ–°åŠŸèƒ½**: ä¼˜å…ˆåœ¨ `core/` æ¨¡å—ä¸­å®ç°å…¬å…±é€»è¾‘
3. **è°ƒè¯•é—®é¢˜**: æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ä¸­çš„ `[BotName]` æ ‡è®°
4. **æ€§èƒ½ä¼˜åŒ–**: å‡å°‘ä¸å¿…è¦çš„ `time.sleep()`ï¼Œä½¿ç”¨æ˜¾å¼ç­‰å¾…

### ä»£ç è§„èŒƒ
- ä½¿ç”¨ç±»å‹æ³¨è§£ï¼ˆ`-> bool`, `-> str`ï¼‰
- æ·»åŠ è¯¦ç»†çš„æ—¥å¿—è¾“å‡ºï¼ˆåŒ…å« emoji æ ‡è®°ï¼‰
- å¼‚å¸¸å¤„ç†ä½¿ç”¨ `try-except` å¹¶æ‰“å°å †æ ˆ
- é€‰æ‹©å™¨ä¼˜å…ˆçº§ï¼šdata-testid > class > tag

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- **DrissionPage æ–‡æ¡£**: https://drissionpage.cn/
- **FastAPI æ–‡æ¡£**: https://fastapi.tiangolo.com/
- **API è°ƒè¯•ç•Œé¢**: http://127.0.0.1:8000/docs (Swagger UI)

---

**æœ€åæ›´æ–°**: 2024å¹´ (åŸºäºæä¾›çš„ä»£ç å¿«ç…§)  
**ç»´æŠ¤è€…**: é¡¹ç›®å¼€å‘è€…  
**è®¸å¯**: æœªæŒ‡å®š